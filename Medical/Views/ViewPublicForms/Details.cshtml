@model Medical.Models.ViewPublicForm
@{
    ViewData["Title"] = "Submission Details";
    ViewBag.ActiveMenu = "Submissions";

    var additionalFieldsData = ViewBag.AdditionalFieldsData as Dictionary<string, Medical.Controllers.AdditionalFieldValue>
        ?? new Dictionary<string, Medical.Controllers.AdditionalFieldValue>();
    
    // Get step information from FormSchemaJson via controller
    var formStepsData = ViewBag.FormSteps as List<Medical.Models.FormStep> ?? new List<Medical.Models.FormStep>();
    
    // Get all unique step numbers from the actual submission data
    var allSteps = additionalFieldsData.Values
        .GroupBy(f => f.Step)
        .OrderBy(g => g.Key)
        .Select(g => g.Key)
        .ToList();
}

<!-- Top Bar -->
<div class="admin-topbar">
    <div>
        <h1 class="admin-topbar-title">Submission Details</h1>
        <p class="admin-topbar-subtitle">
            <i class="fas fa-calendar"></i> Submitted on @Model.CreatedAt.ToString("MMMM dd, yyyy 'at' HH:mm")
        </p>
    </div>
    <div class="admin-topbar-actions">
        <a href="/ViewPublicForms/Index" class="btn-origin btn-origin-secondary">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
        <button type="button" class="btn-origin btn-origin-primary" onclick="window.print()">
            <i class="fas fa-print"></i> Print
        </button>
    </div>
</div>

<!-- Main Content -->
<div class="admin-content">
    
    <!-- Participant Info Card -->
    <div class="origin-card participant-summary-card">
        <div class="origin-card-body">
            <div class="participant-summary">
                <div class="participant-avatar-large">
                    @{
                        var initial = "A";
                        // Try to get initial from any name field in the data
                        var nameField = additionalFieldsData.Values
                            .FirstOrDefault(f => f.DisplayName.ToLower().Contains("name") && !string.IsNullOrEmpty(f.Value));
                        
                        if (nameField != null)
                        {
                            initial = nameField.Value.Substring(0, 1).ToUpper();
                        }
                    }
                    @initial
                </div>
                <div class="participant-summary-details">
                    <h2 class="participant-summary-name">
                        @if (nameField != null)
                        {
                            @nameField.Value
                        }
                        else
                        {
                            @:Anonymous Participant
                        }
                    </h2>
                    <div class="participant-summary-meta">
                        <div class="meta-item">
                            <i class="fas fa-id-card"></i>
                            <span>ID: @Model.ViewPublicFormId.ToString().Substring(0, 8)</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-calendar"></i>
                            <span>@Model.CreatedAt.ToString("MMM dd, yyyy")</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-clock"></i>
                            <span>@Model.CreatedAt.ToString("HH:mm")</span>
                        </div>
                    </div>
                    <div class="participant-summary-badges">
                        <span class="origin-badge origin-badge-success">
                            <i class="fas fa-check-circle"></i> Completed
                        </span>
                        @if (additionalFieldsData.Any())
                        {
                            <span class="origin-badge origin-badge-info">
                                <i class="fas fa-list"></i> @additionalFieldsData.Count Fields
                            </span>
                        }
                        @if (allSteps.Any())
                        {
                            <span class="origin-badge origin-badge-primary">
                                <i class="fas fa-layer-group"></i> @allSteps.Count Steps
                            </span>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 100% DYNAMIC DATA - NO HARDCODED FIELDS -->
    @if (additionalFieldsData.Any())
    {
        foreach (var stepNum in allSteps)
        {
            var fieldsInStep = additionalFieldsData.Values.Where(f => f.Step == stepNum).OrderBy(f => f.DisplayName).ToList();
            
            if (fieldsInStep.Any())
            {
                // Get step name from FormSteps
                var stepData = formStepsData.FirstOrDefault(s => s.Order == stepNum);
                var stepTitle = stepData?.Name ?? $"Step {stepNum}";
                var stepIcon = GetStepIcon(stepNum);
                
                <div class="origin-card step-details-card">
                    <div class="origin-card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3 class="origin-card-title mb-1">
                                    <i class="@stepIcon"></i> @stepTitle
                                </h3>
                                <p class="text-muted mb-0" style="font-size: var(--font-size-xs);">
                                    <i class="fas fa-list"></i> @fieldsInStep.Count field@(fieldsInStep.Count != 1 ? "s" : "") submitted
                                </p>
                            </div>
                            <span class="step-number-badge">Step @stepNum</span>
                        </div>
                    </div>
                    <div class="origin-card-body">
                        <div class="fields-grid">
                            @foreach (var field in fieldsInStep)
                            {
                                <div class="field-display-item">
                                    <div class="field-display-label">
                                        <i class="fas fa-tag"></i>
                                        @field.DisplayName
                                        <span class="field-type-indicator">@field.FieldType</span>
                                    </div>
                                    <div class="field-display-value">
                                        @if (!string.IsNullOrEmpty(field.Value))
                                        {
                                            if (field.FieldType.Equals("checkbox", StringComparison.OrdinalIgnoreCase))
                                            {
                                                <span class="@(field.Value == "true" ? "value-yes" : "value-no")">
                                                    <i class="@(field.Value == "true" ? "fas fa-check-circle" : "fas fa-times-circle")"></i>
                                                    @(field.Value == "true" ? "Yes" : "No")
                                                </span>
                                            }
                                            else if (field.FieldType.Equals("date", StringComparison.OrdinalIgnoreCase) && DateTime.TryParse(field.Value, out DateTime dateValue))
                                            {
                                                <span>
                                                    <i class="fas fa-calendar-day"></i>
                                                    @dateValue.ToString("MMMM dd, yyyy")
                                                </span>
                                            }
                                            else if (field.FieldType.Equals("textarea", StringComparison.OrdinalIgnoreCase))
                                            {
                                                <div class="textarea-value">@field.Value</div>
                                            }
                                            else if (field.FieldType.Equals("email", StringComparison.OrdinalIgnoreCase))
                                            {
                                                <span>
                                                    <i class="fas fa-envelope"></i>
                                                    <a href="mailto:@field.Value" style="color: var(--origin-primary);">@field.Value</a>
                                                </span>
                                            }
                                            else if (field.FieldType.Equals("tel", StringComparison.OrdinalIgnoreCase))
                                            {
                                                <span>
                                                    <i class="fas fa-phone"></i>
                                                    <a href="tel:@field.Value" style="color: var(--origin-primary);">@field.Value</a>
                                                </span>
                                            }
                                            else if (field.FieldType.Equals("radio", StringComparison.OrdinalIgnoreCase))
                                            {
                                                <span class="value-radio">
                                                    <i class="fas fa-dot-circle"></i>
                                                    @field.Value
                                                </span>
                                            }
                                            else if (field.FieldType.Equals("select", StringComparison.OrdinalIgnoreCase))
                                            {
                                                <span class="value-select">
                                                    <i class="fas fa-list-ul"></i>
                                                    @field.Value
                                                </span>
                                            }
                                            else
                                            {
                                                <span>@field.Value</span>
                                            }
                                        }
                                        else
                                        {
                                            <span class="empty-value">
                                                <i class="fas fa-minus-circle"></i> Not provided
                                            </span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        }
    }
    else
    {
        <!-- No Data Message -->
        <div class="origin-card">
            <div class="origin-card-body">
                <div class="origin-empty-state" style="padding: var(--space-2xl);">
                    <div class="origin-empty-state-icon">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <div class="origin-empty-state-title">No Form Data</div>
                    <p class="origin-empty-state-text">This submission does not contain any form field data</p>
                </div>
            </div>
        </div>
    }

    <!-- Summary Statistics -->
    <div class="submission-summary-grid">
        <div class="origin-card">
            <div class="origin-card-body">
                <div class="summary-stat">
                    <div class="summary-stat-icon summary-stat-icon-primary">
                        <i class="fas fa-clipboard-check"></i>
                    </div>
                    <div>
                        <div class="summary-stat-value">@allSteps.Count</div>
                        <div class="summary-stat-label">Steps Completed</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="origin-card">
            <div class="origin-card-body">
                <div class="summary-stat">
                    <div class="summary-stat-icon summary-stat-icon-success">
                        <i class="fas fa-list-check"></i>
                    </div>
                    <div>
                        <div class="summary-stat-value">@additionalFieldsData.Count</div>
                        <div class="summary-stat-label">Total Fields</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="origin-card">
            <div class="origin-card-body">
                <div class="summary-stat">
                    <div class="summary-stat-icon summary-stat-icon-info">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div>
                        <div class="summary-stat-value">
                            @((DateTime.Now - Model.CreatedAt).Days == 0 ? "Today" : $"{(DateTime.Now - Model.CreatedAt).Days}d ago")
                        </div>
                        <div class="summary-stat-label">Submission Time</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Technical Details -->
    @if (!string.IsNullOrEmpty(Model.AdditionalFieldsJson))
    {
        <div class="origin-card">
            <div class="origin-card-header">
                <h3 class="origin-card-title">
                    <i class="fas fa-code"></i> Technical Details
                </h3>
            </div>
            <div class="origin-card-body">
                <div class="technical-details-grid">
                    <div class="technical-detail-item">
                        <div class="technical-detail-label">Form ID</div>
                        <div class="technical-detail-value">@Model.ViewPublicFormId</div>
                    </div>
                    <div class="technical-detail-item">
                        <div class="technical-detail-label">Form Version</div>
                        <div class="technical-detail-value">@Model.FormVersion</div>
                    </div>
                    <div class="technical-detail-item">
                        <div class="technical-detail-label">Created At</div>
                        <div class="technical-detail-value">@Model.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")</div>
                    </div>
                    <div class="technical-detail-item">
                        <div class="technical-detail-label">Total Fields</div>
                        <div class="technical-detail-value">@additionalFieldsData.Count</div>
                    </div>
                </div>
                
                <details class="json-data-collapse">
                    <summary class="json-data-summary">
                        <i class="fas fa-code"></i> View Raw JSON Data
                    </summary>
                    <pre class="json-data-content">@Model.AdditionalFieldsJson</pre>
                </details>
            </div>
        </div>
    }
</div>

@functions {
    private string GetStepIcon(int step)
    {
        // Return icon based on step number
        return step switch
        {
            1 => "fas fa-user",
            2 => "fas fa-heartbeat",
            3 => "fas fa-phone-alt",
            4 => "fas fa-notes-medical",
            _ => "fas fa-clipboard"
        };
    }
}
