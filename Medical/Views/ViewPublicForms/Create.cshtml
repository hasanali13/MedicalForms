@model Medical.Models.ViewPublicForm
@{
    ViewData["Title"] = "Form Builder";
    ViewBag.ActiveMenu = "FormBuilder";

    var additionalFields = ViewBag.AdditionalFields as List<Medical.Models.AdditionalField> ?? new List<Medical.Models.AdditionalField>();
    var customSteps = ViewBag.CustomSteps as List<Medical.Models.AdditionalField> ?? new List<Medical.Models.AdditionalField>();
}

<!-- TOP HEADER -->
<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h2 class="mb-1">Origin Software's Visual Form Builder</h2>
        <p class="text-muted">Build your form with steps, fields, and conditional logic</p>
    </div>
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-primary" onclick="stepModalOpenHandler()">
            ➕ Add Step
        </button>
        <button type="button" class="btn btn-outline-primary" id="openModalBtn">
            ➕ Add Field
        </button>
    </div>
</div>

<!-- Toast Notification Container -->
<div id="toastContainer"></div>

<form asp-action="Create" method="post" autocomplete="off" id="mainForm">
    @Html.AntiForgeryToken()

    <div class="builder-layout">
        <!-- LEFT STEPS PANEL -->
        <div class="left-steps">
            <!-- Top Container: Steps -->
            <div class="left-panel-container">
                <h6 class="text-muted mb-3">FORM STEPS</h6>
                <div id="step1Tab" class="step-item active" data-step="1">
                    <div class="step-pill">
                        <div>
                            <div class="step-title">Step 1</div>
                            <div class="step-subtitle">Personal Information</div>
                        </div>
                        <div class="step-count" id="step1Count">0 fields</div>
                    </div>
                </div>

                <div id="step2Tab" class="step-item" data-step="2">
                    <div class="step-pill">
                        <div>
                            <div class="step-title">Step 2</div>
                            <div class="step-subtitle">Health Details</div>
                        </div>
                        <div class="step-count" id="step2Count">0 fields</div>
                    </div>
                </div>

                <div id="step3Tab" class="step-item" data-step="3">
                    <div class="step-pill">
                        <div>
                            <div class="step-title">Step 3</div>
                            <div class="step-subtitle">Emergency Contact</div>
                        </div>
                        <div class="step-count" id="step3Count">0 fields</div>
                    </div>
                </div>

                <!-- Custom Steps will be rendered here dynamically -->
                <div id="customStepsContainer"></div>
            </div>

            <!-- Bottom Container: Fields -->
            <div class="left-panel-container fields-section">
                <h6>FIELDS IN <span id="currentStepName">PERSONAL INFORMATION</span></h6>

                <div class="fields-list" id="fieldsList">
                    <!-- Render original fields for step 1 -->
                    <div class="field-item" data-field-type="static" data-field-key="FullName">
                        <span class="drag-handle" aria-hidden="true"></span>
                        <span>Full Name</span>
                    </div>
                    <div class="field-item" data-field-type="static" data-field-key="Age">
                        <span class="drag-handle" aria-hidden="true"></span>
                        <span>Age</span>
                    </div>
                    <div class="field-item" data-field-type="static" data-field-key="Gender">
                        <span class="drag-handle" aria-hidden="true"></span>
                        <span>Gender</span>
                    </div>
                    <div class="field-item" data-field-type="static" data-field-key="DateOfBirth">
                        <span class="drag-handle" aria-hidden="true"></span>
                        <span>Date of Birth</span>
                    </div>

                    <!-- Additional dynamic fields for step 1 -->
                    @foreach (var field in additionalFields.Where(f => f.Step == 1))
                    {
                        <div class="field-item" data-field-id="@field.FieldId">
                            <span class="drag-handle" aria-hidden="true"></span>
                            <span>@field.DisplayName</span>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- MIDDLE FORM PANEL -->
        <div class="form-panel">
            <!-- STEP 1 -->
            <div id="step1" class="form-step">
                <h4>Personal Information</h4><hr />

                <!-- Original Fields -->
                <div class="mb-3">
                    <label asp-for="FullName" class="form-label"></label>
                    <input asp-for="FullName" class="form-control" />
                </div>
                <div class="mb-3">
                    <label asp-for="Age" class="form-label"></label>
                    <input asp-for="Age" class="form-control" />
                </div>
                <div class="mb-3">
                    <label asp-for="Gender" class="form-label"></label>
                    <select asp-for="Gender" class="form-control form-select">
                        <option value="">Select</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                        <option value="Prefer not to say">Prefer not to say</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label asp-for="DateOfBirth" class="form-label"></label>
                    <input asp-for="DateOfBirth" type="date" class="form-control" />
                </div>

                <!-- Additional Fields for Step 1 -->
                <div id="step1AdditionalFields">
                    @foreach (var field in additionalFields.Where(f => f.Step == 1))
                    {
                        <div class="additional-field-container" data-field-id="@field.FieldId">
                            <div class="field-actions">
                                <button type="button" class="delete-field-btn" data-field-id="@field.FieldId">
                                    🗑️
                                </button>
                            </div>

                            <label class="form-label">
                                @field.DisplayName
                                @if (field.IsRequired)
                                {
                                    <span class="text-danger">*</span>
                                }
                                <span class="field-type-badge">@field.FieldType</span>
                            </label>

                            @await Html.PartialAsync("_AdditionalFieldInput", field)
                        </div>
                    }
                </div>

                <button type="button" class="btn btn-primary" data-next-step="2">Next</button>
            </div>

            <!-- STEP 2 -->
            <div id="step2" class="form-step hidden">
                <h4>Health Details</h4><hr />

                <!-- Original Fields -->
                <div class="mb-3">
                    <label asp-for="HasAllergies" class="form-label"></label>
                    <select asp-for="HasAllergies" class="form-control form-select" id="HasAllergiesSelect">
                        <option value="">Select</option>
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>

                <div class="mb-3" id="allergyDescriptionGroup">
                    <label asp-for="AllergyDescription" class="form-label"></label>
                    <input asp-for="AllergyDescription" class="form-control" />
                </div>
                <div class="mb-3">
                    <label asp-for="CurrentMedication" class="form-label"></label>
                    <input asp-for="CurrentMedication" class="form-control" />
                </div>
                <div class="mb-3">
                    <label asp-for="HeightCm" class="form-label"></label>
                    <input asp-for="HeightCm" class="form-control" />
                </div>
                <div class="mb-3">
                    <label asp-for="WeightKg" class="form-label"></label>
                    <input asp-for="WeightKg" class="form-control" />
                </div>

                <!-- Additional Fields for Step 2 -->
                <div id="step2AdditionalFields">
                    @foreach (var field in additionalFields.Where(f => f.Step == 2))
                    {
                        <div class="additional-field-container" data-field-id="@field.FieldId">
                            <div class="field-actions">
                                <button type="button" class="delete-field-btn" data-field-id="@field.FieldId">
                                    🗑️
                                </button>
                            </div>

                            <label class="form-label">
                                @field.DisplayName
                                @if (field.IsRequired)
                                {
                                    <span class="text-danger">*</span>
                                }
                                <span class="field-type-badge">@field.FieldType</span>
                            </label>

                            @await Html.PartialAsync("_AdditionalFieldInput", field)
                        </div>
                    }
                </div>

                <button type="button" class="btn btn-secondary" data-prev-step="1">Back</button>
                <button type="button" class="btn btn-primary" data-next-step="3">Next</button>
            </div>

            <!-- STEP 3 -->
            <div id="step3" class="form-step hidden">
                <h4>Emergency Contact</h4><hr />

                <!-- Original Fields -->
                <div class="mb-3" data-field-key="ContactName">
                    <label asp-for="ContactName" class="form-label">@Model.FieldLabels["ContactName"]</label>
                    <input asp-for="ContactName" class="form-control" />
                </div>
                <div class="mb-3" data-field-key="Relationship">
                    <label asp-for="Relationship" class="form-label">@Model.FieldLabels["Relationship"]</label>
                    <input asp-for="Relationship" class="form-control" />
                </div>
                <div class="mb-3" data-field-key="PhoneNumber">
                    <label asp-for="PhoneNumber" class="form-label">@Model.FieldLabels["PhoneNumber"]</label>
                    <input asp-for="PhoneNumber" class="form-control" />
                </div>
                <div class="mb-3" data-field-key="HasAlternativeContact">
                    <label asp-for="HasAlternativeContact" class="form-label">@Model.FieldLabels["HasAlternativeContact"]</label>
                    <input asp-for="HasAlternativeContact" class="form-control" />
                </div>
                <div class="mb-3" data-field-key="AltContactName">
                    <label asp-for="AltContactName" class="form-label">@Model.FieldLabels["AltContactName"]</label>
                    <input asp-for="AltContactName" class="form-control" />
                </div>
                <div class="mb-3" data-field-key="AltPhoneNumber">
                    <label asp-for="AltPhoneNumber" class="form-label">@Model.FieldLabels["AltPhoneNumber"]</label>
                    <input asp-for="AltPhoneNumber" class="form-control" placeholder="Alternative phone" />
                </div>

                <!-- Additional Fields for Step 3 -->
                <div id="step3AdditionalFields">
                    @foreach (var field in additionalFields.Where(f => f.Step == 3))
                    {
                        <div class="additional-field-container" data-field-id="@field.FieldId">
                            <div class="field-actions">
                                <button type="button" class="delete-field-btn" data-field-id="@field.FieldId">
                                    🗑️
                                </button>
                            </div>

                            <label class="form-label">
                                @field.DisplayName
                                @if (field.IsRequired)
                                {
                                    <span class="text-danger">*</span>
                                }
                                <span class="field-type-badge">@field.FieldType</span>
                            </label>

                            @await Html.PartialAsync("_AdditionalFieldInput", field)
                        </div>
                    }
                </div>

                <button type="button" class="btn btn-secondary" data-prev-step="2">Back</button>
                <button type="button" class="btn btn-primary" data-next-step="4" id="step3NextButton">Next</button>
            </div>

            <!-- Custom Steps Forms will be rendered here dynamically -->
            <div id="customStepsForms"></div>
        </div>

        <!-- RIGHT PROPERTIES PANEL -->
        <div class="field-properties-card">
            <div class="fp-header">
                <span class="fp-title">FIELD PROPERTIES</span>
            </div>
            <input type="hidden" id="fpFieldId" />
            <input type="hidden" id="fpFieldType" />
            <div class="fp-group">
                <label>Field Label</label>
                <input id="fpLabel" type="text" class="fp-input" placeholder="Select a field..." />
            </div>
            <div class="fp-group">
                <label>Field Type</label>
                <select id="fpType" class="fp-select">
                    <option value="text">Text</option>
                    <option value="number">Number</option>
                    <option value="date">Date</option>
                    <option value="email">Email</option>
                    <option value="tel">Phone</option>
                    <option value="textarea">Text Area</option>
                    <option value="select">Dropdown</option>
                    <option value="checkbox">Checkbox</option>
                </select>
            </div>
            <div class="fp-group">
                <label>Step</label>
                <select id="fpStep" class="fp-select">
                    <option value="1">Step 1</option>
                    <option value="2">Step 2</option>
                    <option value="3">Step 3</option>
                </select>
            </div>
            <div class="fp-group">
                <label>Placeholder</label>
                <input id="fpPlaceholder" type="text" class="fp-input" placeholder="Optional" />
            </div>
            <div class="fp-toggle-row">
                <span>Required Field</span>
                <label class="switch">
                    <input type="checkbox" id="fpRequired">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="fp-toggle-row">
                <span>Conditional Field</span>
                <label class="switch">
                    <input type="checkbox" id="fpConditional">
                    <span class="slider"></span>
                </label>
            </div>

            <!-- Conditional Logic Configuration -->
            <div id="conditionalConfig" class="fp-conditional-config">
                <div class="fp-group">
                    <label>Show When Field</label>
                    <select id="fpDependsOnField" class="fp-select">
                        <option value="">Select field...</option>
                    </select>
                </div>
                <div class="fp-group">
                    <label>Equals Value</label>
                    <input id="fpShowWhenValue" type="text" class="fp-input" placeholder="e.g., Yes, true, Male" />
                    <div class="conditional-help-text">
                        This field will only show when the selected field has this value
                    </div>
                </div>
            </div>

            <!-- Dropdown options editor - SIMPLIFIED (Just Label) -->
            <div id="fpOptionsEditor" class="fp-options-editor">
                <div class="options-header">
                    <div>
                        <h6>Dropdown Options</h6>
                        <small>Type options that will appear in the dropdown</small>
                    </div>
                </div>
                <div class="options-list" id="fpOptionsList">
                    <!-- Options will be dynamically added here -->
                </div>
                <button type="button" id="fpAddOptionBtn" class="add-option-btn">
                    <i class="fas fa-plus"></i> Add Option
                </button>
            </div>

            <div class="fp-actions">
                <button type="button" id="fpUpdateBtn" class="fp-btn-update" disabled>
                    <i class="fas fa-save"></i> Update
                </button>
                <button type="button" id="fpDeleteBtn" class="fp-btn-delete" disabled>
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
</form>

<!-- ADD FIELD MODAL - WITH INLINE EVENT HANDLERS -->
<div id="addFieldModal" class="modal-overlay" onclick="if(event.target===this) modalCloseHandler()">
    <div class="modal-dialog" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-title">Add New Field</div>
            <button type="button" class="close-btn" onclick="modalCloseHandler()">×</button>
        </div>
        <div class="modal-body">
            <!-- Field Label -->
            <div class="form-group">
                <label class="form-label">
                    Field Label <span class="required-star">*</span>
                </label>
                <input type="text" id="fieldLabelInput" class="form-control-modal"
                       placeholder="e.g., Email Address" required />
                <small class="text-muted" style="font-size: 12px;">This will appear as the field label</small>
            </div>

            <!-- Field Type -->
            <div class="form-group">
                <label class="form-label">Field Type</label>
                <select id="fieldTypeSelect" class="form-control-modal">
                    <option value="text">Text Input</option>
                    <option value="number">Number Input</option>
                    <option value="date">Date Picker</option>
                    <option value="email">Email</option>
                    <option value="tel">Phone</option>
                    <option value="textarea">Text Area</option>
                    <option value="select">Dropdown Select</option>
                    <option value="checkbox">Checkbox</option>
                </select>
            </div>

            <!-- Step Selection -->
            <div class="form-group">
                <label class="form-label">Step</label>
                <select id="fieldStepSelect" class="form-control-modal">
                    <option value="1">Step 1: Personal Information</option>
                    <option value="2">Step 2: Health Details</option>
                    <option value="3">Step 3: Emergency Contact</option>
                </select>
            </div>

            <!-- Placeholder -->
            <div class="form-group">
                <label class="form-label">Placeholder Text (Optional)</label>
                <input type="text" id="fieldPlaceholderInput" class="form-control-modal"
                       placeholder="e.g., Enter your email..." />
            </div>

            <!-- Checkboxes -->
            <div class="checkbox-row" id="requiredCheckboxRow">
                <div id="requiredCheckbox" class="custom-checkbox"></div>
                <label class="checkbox-label">Required field</label>
            </div>

            <div class="checkbox-row" id="conditionalCheckboxRow">
                <div id="conditionalCheckbox" class="custom-checkbox"></div>
                <label class="checkbox-label">Conditional field (shows based on logic)</label>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="modalCloseHandler()">Cancel</button>
            <button type="button" class="btn-primary" onclick="submitAddFieldForm()">Add Field</button>
        </div>
    </div>
</div>

<!-- ADD STEP MODAL -->
<div id="addStepModal" class="modal-overlay" onclick="if(event.target===this) stepModalCloseHandler()">
    <div class="modal-dialog" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-title">Add New Step</div>
            <button type="button" class="close-btn" onclick="stepModalCloseHandler()">×</button>
        </div>
        <div class="modal-body">
            <!-- Step Name -->
            <div class="form-group">
                <label class="form-label">
                    Step Name <span class="required-star">*</span>
                </label>
                <input type="text" id="stepNameInput" class="form-control-modal"
                       placeholder="e.g., Medical History" required />
                <small class="text-muted" style="font-size: 12px;">Name of the new step</small>
            </div>

            <!-- Step Description -->
            <div class="form-group">
                <label class="form-label">Step Description (Optional)</label>
                <input type="text" id="stepDescriptionInput" class="form-control-modal"
                       placeholder="e.g., Details about medical history" />
                <small class="text-muted" style="font-size: 12px;">Brief description of what this step contains</small>
            </div>

            <!-- Step Icon -->
            <div class="form-group">
                <label class="form-label">Step Icon (Optional)</label>
                <select id="stepIconSelect" class="form-control-modal">
                    <option value="📋">📋 Form</option>
                    <option value="🏥">🏥 Hospital</option>
                    <option value="💊">💊 Medicine</option>
                    <option value="🩺">🩺 Stethoscope</option>
                    <option value="📝">📝 Document</option>
                    <option value="🩸">🩸 Blood</option>
                    <option value="🧪">🧪 Test Tube</option>
                    <option value="🧠">🧠 Brain</option>
                    <option value="❤️">❤️ Heart</option>
                    <option value="👨‍⚕️">👨‍⚕️ Doctor</option>
                </select>
                <small class="text-muted" style="font-size: 12px;">Icon to represent this step</small>
            </div>

            <!-- Position -->
            <div class="form-group">
                <label class="form-label">Insert After Step</label>
                <select id="stepPositionSelect" class="form-control-modal" id="stepPosition">
                    <option value="3">After Step 3 (Emergency Contact)</option>
                    <option value="2">After Step 2 (Health Details)</option>
                    <option value="1">After Step 1 (Personal Information)</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="stepModalCloseHandler()">Cancel</button>
            <input type="hidden" id="editingStepId" />
            <button type="button" class="btn-primary" id="addStepSubmitBtn" onclick="submitAddStepForm()">Add Step</button>
            <button type="button" class="btn-primary" id="updateStepSubmitBtn" style="display:none;" onclick="submitUpdateStepForm()">Update Step</button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        window.__formBuilderData = {
            urls: {
                addAdditionalField: '@Url.Action("AddAdditionalField", "ViewPublicForms")',
                deleteAdditionalField: '@Url.Action("DeleteAdditionalField", "ViewPublicForms")',
                updateAdditionalField: '@Url.Action("UpdateAdditionalField", "ViewPublicForms")',
                addCustomStep: '@Url.Action("AddCustomStep", "ViewPublicForms")',
                updateCustomStep: '@Url.Action("UpdateCustomStep", "ViewPublicForms")',
                deleteCustomStep: '@Url.Action("DeleteCustomStep", "ViewPublicForms")',
                updateFieldLabel: '/ViewPublicForms/UpdateFieldLabel'
            },
            additionalFieldsData: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                additionalFields.Select(f => new { f.FieldId, f.DisplayName, f.FieldType, f.Step, f.IsRequired, f.IsConditional, f.Placeholder, f.ConditionalLogicJson, f.OptionsJson, f.FieldName })
            )),
            customStepsData: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                customSteps.Select(s => new { s.FieldId, s.DisplayName, s.Step, s.Placeholder, s.OptionsJson })
            )),
            originalFields: {
                1: ["Full Name","Age","Gender","Date of Birth"],
                2: ["Has Allergies","Allergy Description","Current Medication","Height (cm)","Weight (kg)"],
                3: ["Contact Name","Relationship","Phone Number","Has Alternative Contact","Alt Contact Name","Alt Phone Number"]
            }
        };
    </script>

    <script src="~/js/formbuilder.bundle.js" asp-append-version="true"></script>
    <script src="~/js/formbuilder/groups.js" asp-append-version="true"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (window.bindFormBuilderEvents) window.bindFormBuilderEvents();
            if (window.initFormBuilderPage) window.initFormBuilderPage();
        });
    </script>
}
