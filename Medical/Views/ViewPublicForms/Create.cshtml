@model Medical.Models.ViewPublicForm
@{
    ViewData["Title"] = "Form Builder";
    ViewBag.ActiveMenu = "FormBuilder";

    var additionalFields = ViewBag.AdditionalFields as List<Medical.Models.AdditionalField> ?? new List<Medical.Models.AdditionalField>();
    var customSteps = ViewBag.CustomSteps as List<Medical.Models.AdditionalField> ?? new List<Medical.Models.AdditionalField>();
    
    // IMPORTANT: ReadAllSteps (not filtered by IsActive) to show disabled steps in Form Builder
    var formSchemaJson = ViewBag.FormSchemaJson as string ?? string.Empty;
    var allSteps = Medical.Helpers.FormSchemaStepsHelper.ReadSteps(formSchemaJson);
    var formSteps = allSteps.OrderBy(s => s.Order).ToList();
    
    ViewBag.FormSteps = formSteps; // This now includes disabled steps
}

<!-- TOP HEADER -->
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
    <div>
        <h2 class="mb-1">Origin Software's Visual Form Builder</h2>
        <p class="text-muted">Build your form with steps, fields, and conditional logic</p>
    </div>
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-primary" onclick="stepModalOpenHandler()">
            ➕ Add Step
        </button>
        <button type="button" class="btn btn-outline-primary" id="openModalBtn">
            ➕ Add Field
        </button>
    </div>
</div>

<!-- Toast Notification Container -->
<div id="toastContainer"></div>

<form asp-action="Create" method="post" autocomplete="off" id="mainForm">
    @Html.AntiForgeryToken()

    <div class="builder-layout">
        <!-- LEFT STEPS PANEL -->
        <div class="left-steps">
            <!-- Top Container: Steps -->
            <div class="left-panel-container">
                <h6 class="text-muted mb-3">FORM STEPS</h6>
                
                <!-- Scrollable container for steps -->
                <div class="steps-scroll-container">
                    @if (formSteps != null && formSteps.Count > 0)
                    {
                        @foreach (var step in formSteps)
                        {
                            var isDisabled = !step.IsActive;
                            var stepClass = step.Order == 1 && step.IsActive ? "active" : "";
                            var disabledClass = isDisabled ? "step-disabled" : "";
                            
                            <div id="step@(step.Order)Tab" class="step-item @stepClass @disabledClass" data-step="@step.Order" data-step-id="@step.Id" data-is-active="@step.IsActive.ToString().ToLower()">
                                <div class="step-pill" onclick="@(isDisabled ? "event.stopPropagation()" : $"switchStep({step.Order})")">
                                    <div class="flex-grow-1">
                                        <div class="step-title">
                                            @step.Name
                                            @if (isDisabled)
                                            {
                                                <span class="badge bg-secondary ms-2" style="font-size:10px; vertical-align: middle;">DISABLED</span>
                                            }
                                        </div>
                                        <div class="step-subtitle">
                                            <span class="step-count" id="step@(step.Order)Count">0 fields</span>
                                        </div>
                                    </div>
                                    <div class="step-header-actions" onclick="event.stopPropagation()">
                                        @if (isDisabled)
                                        {
                                            <button type="button" class="btn btn-sm btn-success p-1" 
                                                    onclick="toggleStepStatus('@step.Id', true)" 
                                                    title="Enable Step">
                                                👁️
                                            </button>
                                        }
                                        else
                                        {
                                            <button type="button" class="btn btn-sm btn-link text-primary p-1" 
                                                    onclick="openEditStepModal('@step.Id', @step.Order, '@step.Name')" 
                                                    title="Rename Step">
                                                ✏️
                                            </button>
                                            @if (formSteps.Count(s => s.IsActive) > 1)
                                            {
                                                <button type="button" class="btn btn-sm btn-warning p-1" 
                                                        onclick="confirmDisableStep('@step.Id', '@step.Name')" 
                                                        title="Disable Step">
                                                    🚫
                                                </button>
                                            }
                                            @if (formSteps.Count > 1)
                                            {
                                                <button type="button" class="btn btn-sm btn-link text-danger p-1" 
                                                        onclick="deleteStepHandler('@step.Id')" 
                                                        title="Delete Step">
                                                    🗑️
                                                </button>
                                            }
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div id="step1Tab" class="step-item active" data-step="1">
                            <div class="step-pill">
                                <div>
                                    <div class="step-title">Step 1</div>
                                    <div class="step-subtitle">Default Step</div>
                                </div>
                                <div class="step-count" id="step1Count">0 fields</div>
                            </div>
                        </div>
                    }

                    <!-- Custom Steps will be rendered here dynamically -->
                    <div id="customStepsContainer"></div>
                </div>
            </div>

            <!-- Bottom Container: Fields -->
            <div class="left-panel-container fields-section">
                <h6>FIELDS IN <span id="currentStepName">STEP 1</span></h6>

                <div class="fields-list" id="fieldsList">
                    <!-- All fields will be rendered dynamically by JavaScript -->
                </div>
            </div>
        </div>

        <!-- MIDDLE FORM PANEL -->
        <div class="form-panel">
            @if (formSteps != null && formSteps.Count > 0)
            {
                @foreach (var step in formSteps)
                {
                    var isFirstStep = step.Order == 1;
                    var isLastStep = step.Order == formSteps.Max(s => s.Order);
                    
                    <div id="step@(step.Order)" class="form-step @(step.Order != 1 ? "hidden" : "")">
                        <h4 class="step-title-text">@step.Name</h4><hr />

                        <!-- Additional Fields for this step -->
                        <div id="step@(step.Order)AdditionalFields">
                            @foreach (var field in additionalFields.Where(f => f.Step == step.Order))
                            {
                                <div class="additional-field-container" data-field-id="@field.FieldId">
                                    <div class="field-actions">
                                        <button type="button" class="delete-field-btn" data-field-id="@field.FieldId">
                                            🗑️
                                        </button>
                                    </div>

                                    <label class="form-label">
                                        @field.DisplayName
                                        @if (field.IsRequired)
                                        {
                                            <span class="text-danger">*</span>
                                        }
                                        <span class="field-type-badge">@field.FieldType</span>
                                    </label>

                                    @await Html.PartialAsync("_AdditionalFieldInput", field)
                                </div>
                            }
                        </div>

                        <!-- Navigation buttons will be added dynamically by JavaScript -->
                    </div>
                }
            }
            else
            {
                <div id="step1" class="form-step">
                    <h4>Default Step</h4><hr />
                    <p>No steps configured yet.</p>
                </div>
            }

            <!-- Custom Steps Forms will be rendered here dynamically -->
            <div id="customStepsForms"></div>
        </div>

        <!-- RIGHT PROPERTIES PANEL -->
        <div class="field-properties-card">
            <div class="fp-header">
                <span class="fp-title">FIELD PROPERTIES</span>
            </div>
            <input type="hidden" id="fpFieldId" />
            <input type="hidden" id="fpFieldType" />
            <div class="fp-group">
                <label>Field Label</label>
                <input id="fpLabel" type="text" class="fp-input" placeholder="Select a field..." />
            </div>
            <div class="fp-group">
                <label>Field Type</label>
                <select id="fpType" class="fp-select">
                    <option value="text">Text</option>
                    <option value="number">Number</option>
                    <option value="date">Date</option>
                    <option value="email">Email</option>
                    <option value="tel">Phone</option>
                    <option value="textarea">Text Area</option>
                    <option value="select">Dropdown</option>
                    <option value="radio">Radio</option>
                    <option value="checkbox">Checkbox</option>
                </select>
            </div>
            <div class="fp-group">
                <label>Step</label>
                <select id="fpStep" class="fp-select">
                    @if (formSteps != null && formSteps.Count > 0)
                    {
                        @foreach (var step in formSteps)
                        {
                            <option value="@step.Order">Step @step.Order: @step.Name</option>
                        }
                    }
                    else
                    {
                        <option value="1">Step 1: Default Step</option>
                    }
                </select>
            </div>
            <div class="fp-group">
                <label>Placeholder</label>
                <input id="fpPlaceholder" type="text" class="fp-input" placeholder="Optional" />
            </div>
            <div class="fp-toggle-row">
                <span>Required Field</span>
                <label class="switch">
                    <input type="checkbox" id="fpRequired">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="fp-toggle-row">
                <span>Conditional Field</span>
                <label class="switch">
                    <input type="checkbox" id="fpConditional">
                    <span class="slider"></span>
                </label>
            </div>

            <!-- Conditional Logic Configuration -->
            <div id="conditionalConfig" class="fp-conditional-config">
                <div class="fp-group">
                    <label>Show When Field</label>
                    <select id="fpDependsOnField" class="fp-select">
                        <option value="">Select field...</option>
                    </select>
                </div>
                <div class="fp-group">
                    <label>Equals Value</label>
                    <input id="fpShowWhenValue" type="text" class="fp-input" placeholder="e.g., Yes, true, Male" />
                    <div class="conditional-help-text">
                        This field will only show when the selected field has this value
                    </div>
                </div>
            </div>

            <!-- Dropdown options editor - SIMPLIFIED (Just Label) -->
            <div id="fpOptionsEditor" class="fp-options-editor">
                <div class="options-header">
                    <div>
                        <h6>Dropdown Options</h6>
                        <small>Type options that will appear in the dropdown</small>
                    </div>
                </div>
                <div class="options-list" id="fpOptionsList">
                    <!-- Options will be dynamically added here -->
                </div>
                <button type="button" id="fpAddOptionBtn" class="add-option-btn">
                    <i class="fas fa-plus"></i> Add Option
                </button>
            </div>

            <div class="fp-actions">
                <button type="button" id="fpUpdateBtn" class="fp-btn-update" disabled>
                    <i class="fas fa-save"></i> Update
                </button>
                <button type="button" id="fpDeleteBtn" class="fp-btn-delete" disabled>
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
</form>

<!-- ADD FIELD MODAL - WITH INLINE EVENT HANDLERS -->
<div id="addFieldModal" class="modal-overlay" onclick="if(event.target===this) modalCloseHandler()">
    <div class="modal-dialog" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-title">Add New Field</div>
            <button type="button" class="close-btn" onclick="modalCloseHandler()">×</button>
        </div>
        <div class="modal-body">
            <!-- Field Label -->
            <div class="form-group">
                <label class="form-label">
                    Field Label <span class="required-star">*</span>
                </label>
                <input type="text" id="fieldLabelInput" class="form-control-modal"
                       placeholder="e.g., Email Address" required />
                <small class="text-muted" style="font-size: 12px;">This will appear as the field label</small>
            </div>

            <!-- Field Type -->
            <div class="form-group">
                <label class="form-label">Field Type</label>
                <select id="fieldTypeSelect" class="form-control-modal">
                    <option value="text">Text Input</option>
                    <option value="number">Number Input</option>
                    <option value="date">Date Picker</option>
                    <option value="email">Email</option>
                    <option value="tel">Phone</option>
                    <option value="textarea">Text Area</option>
                    <option value="select">Dropdown Select</option>
                    <option value="radio">Radio Buttons</option>
                    <option value="checkbox">Checkbox</option>
                </select>
            </div>

            <!-- Step Selection -->
            <div class="form-group">
                <label class="form-label">Step</label>
                <select id="fieldStepSelect" class="form-control-modal">
                    @if (formSteps != null && formSteps.Count > 0)
                    {
                        @foreach (var step in formSteps)
                        {
                            <option value="@step.Order">Step @step.Order: @step.Name</option>
                        }
                    }
                    else
                    {
                        <option value="1">Step 1: Default Step</option>
                    }
                </select>
            </div>

            <!-- Placeholder -->
            <div class="form-group">
                <label class="form-label">Placeholder Text (Optional)</label>
                <input type="text" id="fieldPlaceholderInput" class="form-control-modal"
                       placeholder="e.g., Enter your email..." />
            </div>

            <!-- Checkboxes -->
            <div class="checkbox-row" id="requiredCheckboxRow">
                <div id="requiredCheckbox" class="custom-checkbox"></div>
                <label class="checkbox-label">Required field</label>
            </div>

            <div class="checkbox-row" id="conditionalCheckboxRow">
                <div id="conditionalCheckbox" class="custom-checkbox"></div>
                <label class="checkbox-label">Conditional field (shows based on logic)</label>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="modalCloseHandler()">Cancel</button>
            <button type="button" class="btn-primary" onclick="submitAddFieldForm()">Add Field</button>
        </div>
    </div>
</div>

<!-- ADD STEP MODAL -->
<div id="addStepModal" class="modal-overlay" onclick="if(event.target===this) stepModalCloseHandler()">
    <div class="modal-dialog" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-title">Add New Step</div>
            <button type="button" class="close-btn" onclick="stepModalCloseHandler()">×</button>
        </div>
        <div class="modal-body">
            <!-- Step Name -->
            <div class="form-group">
                <label class="form-label">
                    Step Name <span class="required-star">*</span>
                </label>
                <input type="text" id="stepNameInput" class="form-control-modal"
                       placeholder="e.g., Medical History" required />
                <small class="text-muted" style="font-size: 12px;">Name of the new step</small>
            </div>

            <!-- Step Description -->
            <div class="form-group">
                <label class="form-label">Step Description (Optional)</label>
                <input type="text" id="stepDescriptionInput" class="form-control-modal"
                       placeholder="e.g., Details about medical history" />
                <small class="text-muted" style="font-size: 12px;">Brief description of what this step contains</small>
            </div>

            <!-- Step Icon -->
            <div class="form-group">
                <label class="form-label">Step Icon (Optional)</label>
                <select id="stepIconSelect" class="form-control-modal">
                    <option value="📋">📋 Form</option>
                    <option value="🏥">🏥 Hospital</option>
                    <option value="💊">💊 Medicine</option>
                    <option value="🩺">🩺 Stethoscope</option>
                    <option value="📝">📝 Document</option>
                    <option value="🩸">🩸 Blood</option>
                    <option value="🧪">🧪 Test Tube</option>
                    <option value="🧠">🧠 Brain</option>
                    <option value="❤️">❤️ Heart</option>
                    <option value="👨‍⚕️">👨‍⚕️ Doctor</option>
                </select>
                <small class="text-muted" style="font-size: 12px;">Icon to represent this step</small>
            </div>

            <!-- Position -->
            <div class="form-group">
                <label class="form-label">Insert After Step</label>
                <select id="stepPositionSelect" class="form-control-modal">
                    @if (formSteps != null && formSteps.Count > 0)
                    {
                        @foreach (var step in formSteps)
                        {
                            <option value="@step.Order">After Step @step.Order (@step.Name)</option>
                        }
                    }
                    else
                    {
                        <option value="3">After Step 3 (Default)</option>
                    }
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="stepModalCloseHandler()">Cancel</button>
            <input type="hidden" id="editingStepId" />
            <button type="button" class="btn-primary" id="addStepSubmitBtn" onclick="submitAddStepForm()">Add Step</button>
            <button type="button" class="btn-primary" id="updateStepSubmitBtn" style="display:none;" onclick="submitUpdateStepForm()">Update Step</button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        window.__formBuilderData = {
            urls: {
                addAdditionalField: '@Url.Action("AddAdditionalField", "ViewPublicForms")',
                deleteAdditionalField: '@Url.Action("DeleteAdditionalField", "ViewPublicForms")',
                updateAdditionalField: '@Url.Action("UpdateAdditionalField", "ViewPublicForms")',
                addCustomStep: '@Url.Action("AddCustomStep", "ViewPublicForms")',
                updateCustomStep: '@Url.Action("UpdateCustomStep", "ViewPublicForms")',
                deleteCustomStep: '@Url.Action("DeleteCustomStep", "ViewPublicForms")',
                toggleStepActive: '@Url.Action("ToggleStepActive", "ViewPublicForms")',
                updateFieldLabel: '/ViewPublicForms/UpdateFieldLabel'
            },
            additionalFieldsData: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                additionalFields.Select(f => new { f.FieldId, f.DisplayName, f.FieldType, f.Step, f.IsRequired, f.IsConditional, f.Placeholder, f.ConditionalLogicJson, f.OptionsJson, f.FieldName })
            )),
            customStepsData: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                customSteps.Select(s => new { s.FieldId, s.DisplayName, s.Step, s.Placeholder, s.OptionsJson })
            )),
            formStepsData: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(
                formSteps.Select(s => new { s.Id, s.Name, s.Order, s.IsActive, s.Groups })
            ))
        };

        // ===========================
        // STEP ENABLE/DISABLE FUNCTIONS
        // ===========================
        async function confirmDisableStep(stepId, stepName) {
            if (confirm(`⚠️ WARNING: This step will be hidden from public forms.\n\nStep: "${stepName}"\n\nPatients will NOT see this step when filling the form.\n\nContinue?`)) {
                await toggleStepStatus(stepId, false);
            }
        }

        async function toggleStepStatus(stepId, isActive) {
            try {
                const response = await fetch(window.__formBuilderData.urls.toggleStepActive, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getToken()
                    },
                    body: JSON.stringify({ StepId: stepId, IsActive: isActive })
                });

                const result = await response.json();
                if (result.success) {
                    showToast(result.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(result.message, 'error');
                }
            } catch (error) {
                showToast('Error updating step status: ' + error.message, 'error');
            }
        }
    </script>

    <script src="~/js/formbuilder.bundle.js" asp-append-version="true"></script>
    <script src="~/js/formbuilder/options-editor.js" asp-append-version="true"></script>
    <script src="~/js/formbuilder/groups.js" asp-append-version="true"></script>
    <script src="~/js/formbuilder/step-editor.js" asp-append-version="true"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // OPTIMIZED: Single initialization sequence without console logging
            
            // Bind events first
            if (window.bindFormBuilderEvents) {
                window.bindFormBuilderEvents();
            }
            
            // Initialize page state
            if (window.initFormBuilderPage) {
                window.initFormBuilderPage();
            }
            
            // Render groups for active steps (deferred for performance)
            requestAnimationFrame(() => {
                const formStepsData = window.__formBuilderData?.formStepsData || [];
                if (formStepsData.length > 0) {
                    formStepsData.forEach(step => {
                        if (step.IsActive && window.renderGroupsForStep) {
                            try {
                                window.renderGroupsForStep(step.Order);
                            } catch (e) {
                                // Silent fail
                            }
                        }
                    });
                }
                
                // Update field counts (deferred)
                if (window.updateCounts) {
                    window.updateCounts();
                }
                
                // Update navigation buttons
                if (window.updateNavigationButtons) {
                    window.updateNavigationButtons();
                }
                
                // Switch to first active step
                if (formStepsData.length > 0) {
                    const activeSteps = formStepsData.filter(s => s.IsActive !== false).sort((a, b) => a.Order - b.Order);
                    if (activeSteps.length > 0 && window.switchStep) {
                        window.switchStep(activeSteps[0].Order);
                        
                        // Re-render groups for first step (final pass)
                        setTimeout(() => {
                            if (window.renderGroupsForStep) {
                                window.renderGroupsForStep(activeSteps[0].Order);
                            }
                        }, 100);
                    }
                }
            });
        });
        
        // Update counts on field changes
        document.addEventListener('fieldAdded', function() {
            if (window.updateCounts) window.updateCounts();
        });
        
        document.addEventListener('fieldDeleted', function() {
            if (window.updateCounts) window.updateCounts();
        });
        
        document.addEventListener('fieldUpdated', function() {
            if (window.updateCounts) window.updateCounts();
        });
    </script>
}
