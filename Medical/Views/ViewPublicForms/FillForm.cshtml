@model Medical.Models.ViewPublicForm
@{
    ViewData["Title"] = "Fill Form";
    var additionalFields = ViewBag.AdditionalFields as List<Medical.Models.AdditionalField> ?? new List<Medical.Models.AdditionalField>();
    var formSteps = ViewBag.FormSteps as List<Medical.Models.FormStep> ?? new List<Medical.Models.FormStep>();
}

<style>
    * {
        box-sizing: border-box;
    }

    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #e8f5e9 100%);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        padding: 20px;
        min-height: 100vh;
    }

    .container-fillform {
        max-width: 1100px;
        margin: 40px auto;
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }

    .form-header {
        padding: 40px;
        text-align: center;
        background: linear-gradient(135deg, #00796B 0%, #00695C 100%);
        color: white;
        position: relative;
    }

    .form-header h1 {
        margin: 0 0 8px 0;
        font-size: 32px;
        font-weight: 700;
    }

    .form-header p {
        margin: 0;
        opacity: 0.95;
        font-size: 15px;
    }

    .form-header .powered-by {
        margin-top: 12px;
        font-size: 13px;
        opacity: 0.85;
        font-weight: 500;
    }

    .steps-indicator {
        display: flex;
        justify-content: space-between;
        padding: 30px 40px;
        background: #f8f9fa;
        position: relative;
        flex-wrap: wrap;
    }

    .steps-indicator::before {
        content: '';
        position: absolute;
        top: 50px;
        left: 60px;
        right: 60px;
        height: 2px;
        background: #e0e0e0;
        z-index: 0;
    }

    .step-badge {
        flex: 1;
        text-align: center;
        position: relative;
        z-index: 1;
        min-width: 100px;
    }

    .step-number {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: white;
        border: 2px solid #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
        font-weight: 600;
        color: #999;
        transition: all 0.3s;
    }

    .step-number.active {
        background: #00796B;
        border-color: #00796B;
        color: white;
        box-shadow: 0 4px 12px rgba(0, 121, 107, 0.4);
    }

    .step-number.completed {
        background: #4CAF50;
        border-color: #4CAF50;
        color: white;
    }

    .step-label {
        font-size: 12px;
        color: #999;
        font-weight: 500;
        margin-top: 8px;
    }

    .step-label.active {
        color: #00796B;
        font-weight: 600;
    }

    .form-content {
        padding: 40px;
        min-height: 400px;
    }

    .form-step {
        display: none;
        animation: fadeIn 0.3s ease-in;
    }

    .form-step.active {
        display: block;
    }

    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .step-title {
        font-size: 26px;
        font-weight: 700;
        color: #00695C;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        padding-bottom: 16px;
        border-bottom: 2px solid #E8F5E9;
    }

    .step-icon {
        font-size: 28px;
    }

    .step-description {
        font-size: 14px;
        color: #718096;
        margin-bottom: 30px;
        line-height: 1.6;
    }

    /* ============================================
       TWO-COLUMN LAYOUT - DYNAMIC
       ============================================ */
    .fields-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
    }

    .field-column {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .form-group {
        margin-bottom: 0;
    }

    /* Group containers */
    .fillform-group-container {
        background: #F9FAFB;
        border: 1px solid #E5E7EB;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .fillform-group-header {
        margin: 0 0 16px 0;
        font-weight: 700;
        color: #00695C;
        font-size: 17px;
        padding-bottom: 10px;
        border-bottom: 2px solid #B2DFDB;
    }

    .form-label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 8px;
    }

    .required {
        color: #E53E3E;
        margin-left: 4px;
    }

    .form-control {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid #cbd5e0;
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
        background: white;
        transition: all 0.3s;
        appearance: none;
    }

    .form-control:focus {
        outline: none;
        border-color: #00796B;
        box-shadow: 0 0 0 3px rgba(0, 121, 107, 0.1);
        background: white;
    }

    .form-control.form-select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%234a5568' d='M1 1l5 5 5-5'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 36px;
        cursor: pointer;
    }

    textarea.form-control {
        min-height: 100px;
        resize: vertical;
        font-family: inherit;
    }

    .form-control.error {
        border-color: #E53E3E;
        background-color: #FFF5F5;
    }

    .form-control.error:focus {
        box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1);
    }

    .form-group.hidden {
        display: none;
    }

    .form-check {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        user-select: none;
    }

    .form-check-input {
        width: 20px;
        height: 20px;
        cursor: pointer;
        flex-shrink: 0;
        accent-color: #00796B;
    }

    .form-check-label {
        font-size: 14px;
        color: #2d3748;
        cursor: pointer;
        margin-bottom: 0;
    }

    /* Radio Group Styling */
    .radio-group {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 8px;
    }

    .radio-group .form-check {
        padding: 10px 14px;
        background: white;
        border: 1px solid #E5E7EB;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .radio-group .form-check:hover {
        background: #F9FAFB;
        border-color: #00796B;
    }

    .radio-group .form-check-input:checked + .form-check-label {
        color: #00796B;
        font-weight: 600;
    }

    .radio-group .form-check:has(input:checked) {
        background: linear-gradient(135deg, rgba(0, 121, 107, 0.05) 0%, rgba(0, 105, 92, 0.05) 100%);
        border-color: #00796B;
        box-shadow: 0 0 0 3px rgba(0, 121, 107, 0.1);
    }

    .form-actions {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        margin-top: 40px;
        padding-top: 24px;
        border-top: 2px solid #E8F5E9;
    }

    .btn {
        padding: 14px 32px;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-block;
        text-align: center;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-secondary {
        background: white;
        border: 2px solid #cbd5e0;
        color: #2d3748;
        margin-right: auto;
    }

    .btn-secondary:hover:not(:disabled) {
        background: #f7fafc;
        border-color: #a0aec0;
    }

    .btn-primary {
        background: #00796B;
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        background: #00695C;
        box-shadow: 0 4px 12px rgba(0, 121, 107, 0.4);
    }

    .btn-success {
        background: #4CAF50;
        color: white;
    }

    .btn-success:hover:not(:disabled) {
        background: #45A049;
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
    }

    .progress-text {
        font-size: 13px;
        color: #718096;
        text-align: center;
        margin-top: 20px;
    }

    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
    }

    .toast {
        background: #4CAF50;
        color: white;
        padding: 16px 20px;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        animation: slideIn 0.3s ease-out;
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 300px;
    }

    .toast.error {
        background: #E53E3E;
    }

    .toast.info {
        background: #3182CE;
    }

    @@keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* Footer branding */
    .form-footer {
        padding: 20px 40px;
        background: #F9FAFB;
        border-top: 1px solid #E5E7EB;
        text-align: center;
        font-size: 13px;
        color: #6B7280;
    }

    .form-footer strong {
        color: #00695C;
    }

    /* Responsive - Mobile */
    @@media (max-width: 768px) {
        .container-fillform {
            margin: 20px auto;
        }

        .form-header {
            padding: 30px 20px;
        }

        .form-header h1 {
            font-size: 24px;
        }

        .steps-indicator {
            padding: 20px;
            flex-direction: column;
            gap: 15px;
        }

        .steps-indicator::before {
            display: none;
        }

        .form-content {
            padding: 20px;
        }

        .step-title {
            font-size: 20px;
        }

        /* Single column on mobile */
        .fields-row {
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .form-actions {
            flex-direction: column;
        }

        .btn-secondary {
            margin-right: 0;
        }

        .btn {
            width: 100%;
        }

        .toast {
            min-width: auto;
            max-width: 90vw;
        }
    }

    /* Tablet - Keep two columns if space allows */
    @@media (min-width: 769px) and (max-width: 1024px) {
        .container-fillform {
            max-width: 900px;
        }

        .fields-row {
            gap: 20px;
        }
    }
</style>

<form asp-action="FillForm" method="post" id="fillForm">
    @Html.AntiForgeryToken()

    <div class="container-fillform">
        <div class="form-header">
            <h1>Medical Form</h1>
            <p>Please complete all required fields</p>
            <div class="powered-by">Powered by Origin Software's</div>
        </div>

        <!-- Step Indicator -->
        <div class="steps-indicator" id="stepsIndicator">
            <!-- Generated dynamically -->
        </div>

        <!-- Form Content -->
        <div class="form-content" id="formContent">
            <!-- Steps rendered dynamically with two-column layout -->
        </div>

        <!-- Form Actions -->
        <div style="padding: 0 40px 40px 40px;">
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="prevBtn" style="display:none;">
                    ← Back
                </button>
                <button type="button" class="btn btn-primary" id="nextBtn">
                    Next →
                </button>
                <button type="submit" class="btn btn-success" id="submitBtn" style="display:none;">
                    ✓ Submit
                </button>
            </div>

            <div class="progress-text">
                Step <span id="currentStep">1</span> of <span id="totalSteps">1</span>
            </div>
        </div>

        <!-- Footer Branding -->
        <div class="form-footer">
            © @DateTime.Now.Year <strong>Origin Software's</strong>. All Rights Reserved.
        </div>
    </div>
</form>

<div class="toast-container" id="toastContainer"></div>

<script>
    // Data from server - ALL DYNAMIC (no hardcoded fields)
    const allAdditionalFields = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
        additionalFields.Select(f => new { f.FieldId, f.DisplayName, f.FieldType, f.Step, f.IsRequired, f.IsConditional, f.Placeholder, f.ConditionalLogicJson, f.OptionsJson, f.FieldName, f.InputType })
    ));

    const allFormSteps = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
        formSteps.Select(s => new { s.Id, s.Name, s.Order, s.IsActive })
    ));

    // State
    let currentStep = 1;
    let formData = {};

    // Get last step number
    function getLastStep() {
        return allFormSteps.length > 0 ? Math.max(...allFormSteps.map(s => s.Order)) : 1;
    }

    // Render step indicator
    function renderIndicator() {
        const container = document.getElementById('stepsIndicator');
        container.innerHTML = '';

        const activeSteps = allFormSteps.filter(s => s.IsActive !== false).sort((a, b) => a.Order - b.Order);

        activeSteps.forEach(step => {
            const isActive = step.Order === currentStep;
            const isCompleted = step.Order < currentStep;

            const badge = document.createElement('div');
            badge.className = 'step-badge';

            const number = document.createElement('div');
            number.className = 'step-number';
            if (isActive) number.classList.add('active');
            if (isCompleted) number.classList.add('completed');
            number.textContent = isCompleted ? '✓' : step.Order;

            const label = document.createElement('div');
            label.className = 'step-label';
            if (isActive) label.classList.add('active');
            label.textContent = step.Name;

            badge.appendChild(number);
            badge.appendChild(label);
            container.appendChild(badge);
        });

        document.getElementById('currentStep').textContent = currentStep;
        document.getElementById('totalSteps').textContent = getLastStep();
    }

    // Render form steps - FULLY DYNAMIC WITH TWO-COLUMN LAYOUT
    function renderForm() {
        const container = document.getElementById('formContent');
        container.innerHTML = '';

        const activeSteps = allFormSteps.filter(s => s.IsActive !== false).sort((a, b) => a.Order - b.Order);

        activeSteps.forEach(step => {
            const stepDiv = document.createElement('div');
            stepDiv.className = 'form-step';
            if (step.Order === currentStep) stepDiv.classList.add('active');
            stepDiv.id = `step-${step.Order}`;

            // Step title
            const titleEl = document.createElement('div');
            titleEl.className = 'step-title';
            titleEl.textContent = step.Name;
            stepDiv.appendChild(titleEl);

            // Get dynamic fields for this step
            const dynamicFields = allAdditionalFields.filter(f => f.Step === step.Order);
            
            if (dynamicFields.length === 0) {
                const emptyMsg = document.createElement('p');
                emptyMsg.className = 'step-description';
                emptyMsg.textContent = 'No fields configured for this step.';
                stepDiv.appendChild(emptyMsg);
            } else {
                // Get groups for this step
                const groups = getGroupsForStep(step.Order);
                const dynamicById = new Map(dynamicFields.map(f => [String(f.FieldId), f]));
                const used = new Set();

                // Render grouped fields
                groups.forEach(g => {
                    const groupFields = g.fieldIds
                        .map(fid => dynamicById.get(String(fid)))
                        .filter(f => f != null);
                    
                    if (groupFields.length > 0) {
                        // Create group container
                        const groupContainer = document.createElement('div');
                        groupContainer.className = 'fillform-group-container';
                        
                        // Group header (optional)
                        if (g.name && g.name.trim()) {
                            const groupHeader = document.createElement('div');
                            groupHeader.className = 'fillform-group-header';
                            groupHeader.textContent = g.name;
                            groupContainer.appendChild(groupHeader);
                        }

                        // Split group fields into two columns
                        const fieldsRow = createTwoColumnLayout(groupFields);
                        groupContainer.appendChild(fieldsRow);
                        
                        stepDiv.appendChild(groupContainer);
                        
                        // Mark as used
                        groupFields.forEach(f => used.add(String(f.FieldId)));
                    }
                });

                // Ungrouped fields - render in two columns
                const ungroupedFields = dynamicFields.filter(f => !used.has(String(f.FieldId)));
                if (ungroupedFields.length > 0) {
                    const fieldsRow = createTwoColumnLayout(ungroupedFields);
                    stepDiv.appendChild(fieldsRow);
                }
            }

            container.appendChild(stepDiv);
        });

        setupFormListeners();
        evaluateConditionalFields();
    }

    // Create two-column layout for fields
    function createTwoColumnLayout(fields) {
        const rowContainer = document.createElement('div');
        rowContainer.className = 'fields-row';

        // Create left and right columns
        const leftColumn = document.createElement('div');
        leftColumn.className = 'field-column';
        
        const rightColumn = document.createElement('div');
        rightColumn.className = 'field-column';

        // Split fields: left gets ceil(n/2), right gets floor(n/2)
        const mid = Math.ceil(fields.length / 2);
        
        fields.forEach((field, index) => {
            const fieldElement = renderField(field.FieldId, field);
            
            if (index < mid) {
                leftColumn.appendChild(fieldElement);
            } else {
                rightColumn.appendChild(fieldElement);
            }
        });

        rowContainer.appendChild(leftColumn);
        rowContainer.appendChild(rightColumn);
        
        return rowContainer;
    }

    // Render single field
    function renderField(fieldId, field) {
        const group = document.createElement('div');
        group.className = 'form-group';
        group.setAttribute('data-field-id', String(fieldId));
        group.setAttribute('data-original-required', String(field.IsRequired === true));
        
        if (field.IsConditional && field.ConditionalLogicJson) {
            group.setAttribute('data-conditional-logic', field.ConditionalLogicJson);
            group.style.display = 'none';
        }

        const label = document.createElement('label');
        label.className = 'form-label';

        const labelText = field.DisplayName;
        const isRequired = field.IsRequired;
        const fieldType = field.FieldType;
        const placeholder = field.Placeholder || '';

        label.textContent = labelText;
        if (isRequired) {
            const span = document.createElement('span');
            span.className = 'required';
            span.textContent = '*';
            label.appendChild(span);
        }

        group.appendChild(label);

        // Helper function to trigger conditional evaluation
        const triggerEvaluation = () => {
            setTimeout(() => evaluateConditionalFields(), 0);
        };

        // Create input based on type
        let input;

        if (fieldType === 'textarea') {
            input = document.createElement('textarea');
            input.className = 'form-control';
            input.placeholder = placeholder;
            input.rows = 4;
        } else if (fieldType === 'select') {
            input = document.createElement('select');
            input.className = 'form-control form-select';

            const options = field.OptionsJson ? JSON.parse(field.OptionsJson).map(o => o.Label || o.label) : [];
            
            if (!isRequired) {
                const emptyOpt = document.createElement('option');
                emptyOpt.value = '';
                emptyOpt.textContent = 'Select an option...';
                input.appendChild(emptyOpt);
            }
            
            options.forEach(opt => {
                const optEl = document.createElement('option');
                optEl.value = opt;
                optEl.textContent = opt;
                input.appendChild(optEl);
            });
        } else if (fieldType === 'radio') {
            const radioContainer = document.createElement('div');
            radioContainer.className = 'radio-group';

            const options = field.OptionsJson ? JSON.parse(field.OptionsJson) : [];
            
            if (options.length > 0) {
                options.forEach((opt, index) => {
                    const radioDiv = document.createElement('div');
                    radioDiv.className = 'form-check';

                    const radioInput = document.createElement('input');
                    radioInput.type = 'radio';
                    radioInput.className = 'form-check-input';
                    radioInput.name = field.FieldName || fieldId;
                    radioInput.id = `${field.FieldName || fieldId}_${index}`;
                    radioInput.value = opt.Value || opt.value || opt.Label || opt.label || opt;
                    
                    if (opt.IsDefault || opt.isDefault) {
                        radioInput.checked = true;
                        formData[fieldId] = radioInput.value;
                    }
                    
                    if (isRequired && index === 0) {
                        radioInput.required = true;
                    }

                    const radioLabel = document.createElement('label');
                    radioLabel.className = 'form-check-label';
                    radioLabel.setAttribute('for', `${field.FieldName || fieldId}_${index}`);
                    radioLabel.textContent = opt.Label || opt.label || opt.Value || opt.value || opt;

                    // Multiple event listeners for immediate response
                    radioInput.addEventListener('click', () => {
                        formData[fieldId] = radioInput.value;
                        triggerEvaluation();
                    });
                    radioInput.addEventListener('change', () => {
                        formData[fieldId] = radioInput.value;
                        triggerEvaluation();
                    });

                    radioDiv.appendChild(radioInput);
                    radioDiv.appendChild(radioLabel);
                    radioContainer.appendChild(radioDiv);
                });
            } else {
                const noOptions = document.createElement('p');
                noOptions.style.color = '#999';
                noOptions.style.fontSize = '14px';
                noOptions.textContent = 'No options configured';
                radioContainer.appendChild(noOptions);
            }

            group.appendChild(radioContainer);
            return group;
        } else if (fieldType === 'checkbox') {
            const checkDiv = document.createElement('div');
            checkDiv.className = 'form-check';

            input = document.createElement('input');
            input.type = 'checkbox';
            input.className = 'form-check-input';
            input.value = 'true';

            const checkLabel = document.createElement('label');
            checkLabel.className = 'form-check-label';
            checkLabel.textContent = labelText;

            checkDiv.appendChild(input);
            checkDiv.appendChild(checkLabel);

            group.innerHTML = '';
            group.setAttribute('data-field-id', String(fieldId));
            group.setAttribute('data-original-required', String(field.IsRequired === true));
            
            if (field.IsConditional && field.ConditionalLogicJson) {
                group.setAttribute('data-conditional-logic', field.ConditionalLogicJson);
                group.style.display = 'none';
            }
            
            group.appendChild(checkDiv);
            
            const hiddenFalse = document.createElement('input');
            hiddenFalse.type = 'hidden';
            hiddenFalse.value = 'false';
            hiddenFalse.name = field.FieldName || fieldId;
            group.appendChild(hiddenFalse);
            
            input.name = field.FieldName || fieldId;
            if (isRequired) input.required = true;
            
            // Multiple event listeners for immediate response
            input.addEventListener('click', () => {
                formData[fieldId] = input.checked;
                triggerEvaluation();
            });
            input.addEventListener('change', () => {
                formData[fieldId] = input.checked;
                triggerEvaluation();
            });
            
            return group;
        } else if (fieldType === 'date') {
            input = document.createElement('input');
            input.type = 'date';
            input.className = 'form-control';
        } else if (fieldType === 'number') {
            input = document.createElement('input');
            input.type = 'number';
            input.className = 'form-control';
            input.placeholder = placeholder;
        } else if (fieldType === 'email') {
            input = document.createElement('input');
            input.type = 'email';
            input.className = 'form-control';
            input.placeholder = placeholder;
        } else if (fieldType === 'tel') {
            input = document.createElement('input');
            input.type = 'tel';
            input.className = 'form-control';
            input.placeholder = placeholder;
        } else {
            input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control';
            input.placeholder = placeholder;
        }

        input.name = field.FieldName || fieldId;
        if (isRequired) input.required = true;

        if (formData[fieldId] !== undefined) {
            if (fieldType === 'checkbox') input.checked = formData[fieldId];
            else input.value = formData[fieldId];
        }

        // Multiple event listeners for immediate response
        input.addEventListener('change', () => {
            formData[fieldId] = fieldType === 'checkbox' ? input.checked : input.value;
            triggerEvaluation();
        });
        
        input.addEventListener('input', () => {
            formData[fieldId] = fieldType === 'checkbox' ? input.checked : input.value;
            triggerEvaluation();
        });
        
        // Additional click listener for select dropdowns
        if (fieldType === 'select') {
            input.addEventListener('click', () => {
                triggerEvaluation();
            });
        }

        group.appendChild(input);
        return group;
    }

    // Evaluate conditional fields (permanent implementation)
    function evaluateConditionalFields() {
        console.log('=== Evaluating Conditional Fields ===');
        
        document.querySelectorAll('[data-conditional-logic]').forEach(fieldContainer => {
            try {
                const logicJson = fieldContainer.getAttribute('data-conditional-logic');
                if (!logicJson) return;
                
                const logic = JSON.parse(logicJson);
                
                // Support multiple property name variations
                const parentFieldId = logic.parentFieldId || logic.ParentFieldId || logic.DependsOnFieldKey || logic.dependsOnFieldKey;
                const expectedValue = logic.expectedValue || logic.ExpectedValue || logic.ShowWhenValue || logic.showWhenValue;
                const action = logic.action || logic.Action || 'show';
                
                console.log('Conditional Field Logic:', {
                    logicJson,
                    parentFieldId,
                    expectedValue,
                    action
                });
                
                if (!parentFieldId) {
                    console.warn('No parentFieldId found in logic');
                    return;
                }
                
                const parentContainer = document.querySelector(`[data-field-id="${parentFieldId}"]`);
                if (!parentContainer) {
                    console.warn(`Parent container not found for field ID: ${parentFieldId}`);
                    return;
                }
                
                let parentValue = '';
                const parentInput = parentContainer.querySelector('input[type="radio"]:checked, input[type="checkbox"], input:not([type="radio"]):not([type="checkbox"]), select, textarea');
                
                if (parentInput) {
                    if (parentInput.type === 'checkbox') {
                        parentValue = parentInput.checked ? 'true' : 'false';
                    } else if (parentInput.type === 'radio') {
                        parentValue = parentInput.value || '';
                    } else {
                        parentValue = parentInput.value || '';
                    }
                }
                
                console.log('Parent Value:', parentValue);
                
                // FIXED: Support both exact match AND multiple trigger values
                let conditionMet = false;
                
                // Normalize for comparison
                const normalizedParentValue = String(parentValue).toLowerCase().trim();
                const normalizedExpectedValue = String(expectedValue || '').toLowerCase().trim();
                
                console.log('Normalized Values:', {
                    normalizedParentValue,
                    normalizedExpectedValue
                });
                
                // First: Check for exact match (handles values with commas)
                if (normalizedParentValue === normalizedExpectedValue) {
                    conditionMet = true;
                    console.log('Condition met: EXACT MATCH');
                } 
                // Second: Check if expectedValue is a multi-value list
                else if (expectedValue && expectedValue.includes(',')) {
                    // Split by comma and check if any value matches
                    const allowedValues = expectedValue.split(',').map(v => v.trim().toLowerCase());
                    conditionMet = allowedValues.some(allowedVal => allowedVal === normalizedParentValue);
                    console.log('Checking multi-value:', { allowedValues, conditionMet });
                }
                
                const shouldShow = (action === 'show' && conditionMet) || (action === 'hide' && !conditionMet);
                
                console.log('Evaluation Result:', {
                    conditionMet,
                    action,
                    shouldShow,
                    currentDisplay: fieldContainer.style.display
                });
                
                const inputs = fieldContainer.querySelectorAll('input, select, textarea');
                const wasRequired = fieldContainer.getAttribute('data-original-required') === 'true';
                
                if (shouldShow) {
                    console.log('SHOWING FIELD');
                    fieldContainer.style.display = '';
                    inputs.forEach(inp => {
                        inp.disabled = false;
                        if (wasRequired && inp.type !== 'hidden') {
                            inp.required = true;
                        }
                    });
                } else {
                    console.log('HIDING FIELD');
                    fieldContainer.style.display = 'none';
                    inputs.forEach(inp => {
                        inp.disabled = true;
                        inp.required = false;
                    });
                }
            } catch (e) {
                console.error('Error evaluating conditional logic:', e);
            }
        });
        
        console.log('=== End Conditional Evaluation ===');
    }

    // Apply conditional logic (legacy support)
    function applyConditional() {
        evaluateConditionalFields();
    }

    // Validate step
    function validateStep(step) {
        const stepEl = document.getElementById(`step-${step}`);
        if (!stepEl) return true;

        const requiredInputs = stepEl.querySelectorAll('[required]:not([disabled])');
        let valid = true;

        requiredInputs.forEach(input => {
            const group = input.closest('.form-group');
            if (group && group.style.display === 'none') return;

            let isValid = false;
            if (input.type === 'checkbox') {
                isValid = input.checked;
            } else if (input.type === 'radio') {
                const name = input.name;
                const checked = stepEl.querySelector(`input[name="${name}"]:checked`);
                isValid = checked !== null;
            } else {
                isValid = input.value.trim() !== '';
            }

            if (!isValid) {
                input.classList.add('error');
                valid = false;
            } else {
                input.classList.remove('error');
            }
        });

        return valid;
    }

    // Navigate to step
    function goToStep(step) {
        const lastStep = getLastStep();
        if (step < 1 || step > lastStep) return;

        if (step > currentStep && !validateStep(currentStep)) {
            showToast('Please fill all required fields', 'error');
            return;
        }

        document.getElementById(`step-${currentStep}`).classList.remove('active');
        currentStep = step;
        document.getElementById(`step-${currentStep}`).classList.add('active');

        renderIndicator();
        updateButtons();
        
        // Ensure conditional fields are evaluated after step change
        setTimeout(() => evaluateConditionalFields(), 0);
        
        window.scrollTo(0, 0);
    }

    // Update button visibility
    function updateButtons() {
        const lastStep = getLastStep();
        document.getElementById('prevBtn').style.display = currentStep === 1 ? 'none' : 'inline-block';
        document.getElementById('nextBtn').style.display = currentStep === lastStep ? 'none' : 'inline-block';
        document.getElementById('submitBtn').style.display = currentStep === lastStep ? 'inline-block' : 'none';
    }

    // Setup form listeners
    function setupFormListeners() {
        // Already handled in renderField
    }

    // Show toast
    function showToast(message, type = 'success') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    // Form submit
    document.getElementById('fillForm').addEventListener('submit', function(e) {
        if (!validateStep(currentStep)) {
            e.preventDefault();
            showToast('Please fill all required fields', 'error');
            return;
        }

        showToast('Submitting...', 'info');
    });

    // Button handlers
    document.getElementById('nextBtn').addEventListener('click', () => goToStep(currentStep + 1));
    document.getElementById('prevBtn').addEventListener('click', () => goToStep(currentStep - 1));

    // Form Builder grouping
    const GROUPING_STORAGE_KEY = 'formbuilder.grouping.v1';

    function safeJsonParse(text, fallback) {
        try { return JSON.parse(text); } catch { return fallback; }
    }

    function getGroupingStore() {
        try {
            return safeJsonParse(localStorage.getItem(GROUPING_STORAGE_KEY) || '', { steps: {} });
        } catch {
            return { steps: {} };
        }
    }

    function getGroupsForStep(stepNum) {
        const store = getGroupingStore();
        const st = (store.steps && store.steps[String(stepNum)]) ? store.steps[String(stepNum)] : null;
        const groups = st && Array.isArray(st.groups) ? st.groups : [];

        return groups
            .map(g => ({
                groupId: String(g.groupId || ''),
                name: (g.name || '').trim(),
                fieldIds: Array.isArray(g.fieldIds) ? g.fieldIds.map(x => String(x)) : []
            }))
            .filter(g => g.groupId && g.fieldIds.length > 0);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        renderIndicator();
        renderForm();
        updateButtons();
        
        // Initial evaluation of conditional fields
        setTimeout(() => evaluateConditionalFields(), 100);
    });
</script>
