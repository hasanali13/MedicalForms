@using System.Linq
@model IEnumerable<Medical.Models.ViewPublicForm>
@{
    ViewData["Title"] = "Submissions";
    ViewBag.ActiveMenu = "Submissions";
    
    var configFields = ViewBag.ConfigFields as List<Medical.Models.AdditionalField> ?? new List<Medical.Models.AdditionalField>();
    var customSteps = ViewBag.CustomSteps as List<Medical.Models.AdditionalField> ?? new List<Medical.Models.AdditionalField>();
}

<!-- Top Bar -->
<div class="admin-topbar">
    <div>
        <h1 class="admin-topbar-title">Form Submissions</h1>
        <p class="admin-topbar-subtitle">
            <i class="fas fa-inbox"></i> Manage and review all form submissions
        </p>
    </div>
    <div class="admin-topbar-actions">
        <button type="button" class="btn-origin btn-origin-secondary" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <a href="/ViewPublicForms/Create" class="btn-origin btn-origin-primary">
            <i class="fas fa-plus"></i> New Entry
        </a>
    </div>
</div>

<!-- Main Content -->
<div class="admin-content">

    <!-- Success Message -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="origin-card" style="margin-bottom: var(--space-xl); background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(52, 211, 153, 0.05) 100%); border-left: 4px solid #10B981;">
            <div class="origin-card-body">
                <div class="d-flex align-items-center gap-3">
                    <div style="width: 40px; height: 40px; background: rgba(16, 185, 129, 0.1); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-check-circle" style="color: #10B981; font-size: 20px;"></i>
                    </div>
                    <div>
                        <div style="font-weight: var(--font-weight-semibold); color: #10B981; margin-bottom: 4px;">Success</div>
                        <div style="color: var(--origin-text-secondary); font-size: var(--font-size-sm);">@TempData["SuccessMessage"]</div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Summary Stats -->
    <div class="submissions-stats-grid">
        <div class="stat-card stat-card-enhanced">
            <div class="stat-card-header">
                <div class="stat-card-icon">
                    <i class="fas fa-clipboard-list"></i>
                </div>
            </div>
            <div class="stat-card-body">
                <div class="stat-card-value">@Model.Count()</div>
                <div class="stat-card-label">Total Submissions</div>
                <div class="stat-card-description">All-time form responses</div>
            </div>
        </div>

        <div class="stat-card stat-card-enhanced">
            <div class="stat-card-header">
                <div class="stat-card-icon" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(96, 165, 250, 0.1) 100%);">
                    <i class="fas fa-calendar-day" style="color: #3B82F6;"></i>
                </div>
            </div>
            <div class="stat-card-body">
                <div class="stat-card-value" style="color: #3B82F6;">@Model.Count(m => m.CreatedAt.Date == DateTime.Today)</div>
                <div class="stat-card-label">Today's Submissions</div>
                <div class="stat-card-description">Received in last 24 hours</div>
            </div>
        </div>

        <div class="stat-card stat-card-enhanced">
            <div class="stat-card-header">
                <div class="stat-card-icon" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(52, 211, 153, 0.1) 100%);">
                    <i class="fas fa-user-check" style="color: #10B981;"></i>
                </div>
            </div>
            <div class="stat-card-body">
                <div class="stat-card-value" style="color: #10B981;">@Model.Count(m => !string.IsNullOrEmpty(m.FullName))</div>
                <div class="stat-card-label">Identified Participants</div>
                <div class="stat-card-description">With full name provided</div>
            </div>
        </div>

        <div class="stat-card stat-card-enhanced">
            <div class="stat-card-header">
                <div class="stat-card-icon" style="background: linear-gradient(135deg, rgba(201, 162, 77, 0.1) 0%, rgba(212, 179, 106, 0.1) 100%);">
                    <i class="fas fa-list-check" style="color: var(--origin-accent);"></i>
                </div>
            </div>
            <div class="stat-card-body">
                <div class="stat-card-value" style="color: var(--origin-accent);">@Model.Count(m => !string.IsNullOrEmpty(m.AdditionalFieldsJson))</div>
                <div class="stat-card-label">With Additional Data</div>
                <div class="stat-card-description">Dynamic fields completed</div>
            </div>
        </div>
    </div>

    <!-- Submissions Table -->
    @if (!Model.Any())
    {
        <div class="origin-empty-state" style="padding: var(--space-2xl) var(--space-xl);">
            <div class="origin-empty-state-icon">
                <i class="fas fa-inbox"></i>
            </div>
            <div class="origin-empty-state-title">No Submissions Yet</div>
            <p class="origin-empty-state-text">When forms are submitted, they will appear here for review and management</p>
            <a href="/ViewPublicForms/FillForm" class="btn-origin btn-origin-primary mt-3">
                <i class="fas fa-external-link-alt"></i> Preview Public Form
            </a>
        </div>
    }
    else
    {
        <div class="submissions-table-card">
            <div class="submissions-table-header">
                <div>
                    <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); color: var(--origin-text-primary); margin: 0;">
                        <i class="fas fa-table"></i> All Submissions
                    </h3>
                    <p style="font-size: var(--font-size-xs); color: var(--origin-text-muted); margin: 0; margin-top: 4px;">
                        Showing @Model.Count() submission@(Model.Count() != 1 ? "s" : "")
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <select class="form-control form-select" style="font-size: var(--font-size-xs); padding: var(--space-xs) var(--space-md); min-width: 150px;">
                        <option>All Time</option>
                        <option>Today</option>
                        <option>Last 7 Days</option>
                        <option>Last 30 Days</option>
                    </select>
                </div>
            </div>
            
            <div class="submissions-table-wrapper">
                <table class="submissions-table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-user"></i> Participant</th>
                            <th><i class="fas fa-phone"></i> Contact Info</th>
                            <th><i class="fas fa-heartbeat"></i> Health Data</th>
                            <th><i class="fas fa-list"></i> Additional Fields</th>
                            <th><i class="fas fa-calendar"></i> Submitted</th>
                            <th><i class="fas fa-cog"></i> Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr>
                                <!-- Participant -->
                                <td data-label="Participant">
                                    <div class="submission-user-cell">
                                        <div class="submission-user-avatar">
                                            @{
                                                string initials = "A";
                                                if (!string.IsNullOrWhiteSpace(item.FullName))
                                                {
                                                    var parts = item.FullName.Split(' ', System.StringSplitOptions.RemoveEmptyEntries);
                                                    if (parts.Length > 0)
                                                    {
                                                        initials = string.Concat(
                                                            parts.Take(Math.Min(2, parts.Length))
                                                                .Where(p => !string.IsNullOrEmpty(p))
                                                                .Select(p => p[0].ToString().ToUpper())
                                                        );
                                                    }
                                                }
                                            }
                                            @initials
                                        </div>
                                        <div class="submission-user-info">
                                            <div class="submission-user-name">
                                                @(item.FullName ?? "Anonymous Participant")
                                            </div>
                                            <div class="submission-user-id">
                                                ID: @item.ViewPublicFormId.ToString().Substring(0, 8)
                                            </div>
                                        </div>
                                    </div>
                                </td>

                                <!-- Contact Info -->
                                <td data-label="Contact">
                                    @if (!string.IsNullOrEmpty(item.ContactName))
                                    {
                                        <div style="margin-bottom: 4px;">
                                            <strong style="color: var(--origin-text-primary); font-size: var(--font-size-sm);">@item.ContactName</strong>
                                        </div>
                                        @if (!string.IsNullOrEmpty(item.Relationship))
                                        {
                                            <div style="font-size: var(--font-size-xs); color: var(--origin-text-muted);">
                                                <i class="fas fa-user-friends"></i> @item.Relationship
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(item.PhoneNumber))
                                        {
                                            <div style="font-size: var(--font-size-xs); color: var(--origin-text-secondary); margin-top: 2px;">
                                                <i class="fas fa-phone"></i> @item.PhoneNumber
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <span class="empty-value">No contact provided</span>
                                    }
                                </td>

                                <!-- Health Data -->
                                <td data-label="Health">
                                    <div class="d-flex flex-column gap-1" style="font-size: var(--font-size-xs);">
                                        @if (item.Age.HasValue)
                                        {
                                            <div style="color: var(--origin-text-secondary);">
                                                <i class="fas fa-birthday-cake"></i> @item.Age years old
                                            </div>
                                        }
                                        @if (item.HeightCm.HasValue && item.WeightKg.HasValue)
                                        {
                                            <div style="color: var(--origin-text-secondary);">
                                                <i class="fas fa-weight"></i> @item.HeightCm.Value.ToString("0.#") cm / @item.WeightKg.Value.ToString("0.#") kg
                                            </div>
                                        }
                                        @if (item.HasAllergies.HasValue)
                                        {
                                            <div style="color: @(item.HasAllergies.Value ? "var(--origin-error)" : "var(--origin-success)");">
                                                <i class="fas @(item.HasAllergies.Value ? "fa-exclamation-triangle" : "fa-check-circle")"></i>
                                                @(item.HasAllergies.Value ? "Has Allergies" : "No Allergies")
                                            </div>
                                        }
                                    </div>
                                </td>

                                <!-- Additional Fields -->
                                <td data-label="Additional Fields">
                                    @{ 
                                      var additionalData = new Dictionary<string, object>();
                                      if (!string.IsNullOrEmpty(item.AdditionalFieldsJson))
                                      {
                                          try
                                          {
                                              additionalData = Newtonsoft.Json.JsonConvert.DeserializeObject<Dictionary<string, object>>(item.AdditionalFieldsJson);
                                          }
                                          catch
                                          {
                                              additionalData = new Dictionary<string, object>();
                                          }
                                      }
                                    }
                                    
                                    @if (additionalData.Count > 0)
                                    {
                                        <div class="submission-fields-summary">
                                            <div class="fields-count-badge">
                                                <i class="fas fa-database"></i>
                                                <span>@additionalData.Count fields</span>
                                            </div>
                                            
                                            <div class="field-tags-list">
                                                @{
                                                    var fieldsByStep = new Dictionary<int, int>();
                                                    
                                                    foreach (var field in additionalData)
                                                    {
                                                        var fieldName = field.Key;
                                                        var configField = configFields.FirstOrDefault(f => f.FieldName == fieldName);
                                                        var stepNum = configField?.Step ?? 1;
                                                        
                                                        if (!fieldsByStep.ContainsKey(stepNum))
                                                        {
                                                            fieldsByStep[stepNum] = 0;
                                                        }
                                                        fieldsByStep[stepNum]++;
                                                    }
                                                }
                                                
                                                @foreach (var stepGroup in fieldsByStep.OrderBy(g => g.Key))
                                                {
                                                    var stepNumber = stepGroup.Key;
                                                    var stepName = stepNumber <= 3 ? $"Step {stepNumber}" : "";
                                                    
                                                    if (stepNumber > 3)
                                                    {
                                                        var customStep = customSteps.FirstOrDefault(s => s.Step == stepNumber);
                                                        if (customStep != null)
                                                        {
                                                            stepName = customStep.DisplayName;
                                                        }
                                                    }
                                                    
                                                    if (!string.IsNullOrEmpty(stepName))
                                                    {
                                                        <span class="field-tag">
                                                            <span class="step-badge-tag">@stepName</span>
                                                            @stepGroup.Value field@(stepGroup.Value != 1 ? "s" : "")
                                                        </span>
                                                    }
                                                }
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="empty-value">None</span>
                                    }
                                </td>

                                <!-- Submitted Date -->
                                <td data-label="Submitted">
                                    <div class="submission-date-cell">
                                        <strong>@item.CreatedAt.ToString("MMM dd, yyyy")</strong>
                                        <small>@item.CreatedAt.ToString("HH:mm")</small>
                                    </div>
                                </td>

                                <!-- Actions -->
                                <td data-label="Actions">
                                    <div class="submission-actions">
                                        <a href="/ViewPublicForms/Details/@item.ViewPublicFormId" class="btn-origin btn-origin-primary btn-origin-sm" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        @if (item.IsDeleted != true)
                                        {
                                            <a href="/ViewPublicForms/Delete/@item.ViewPublicFormId" class="btn-origin btn-origin-danger btn-origin-sm" title="Delete" onclick="return confirm('Are you sure you want to delete this submission?');">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>
